<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyszukiwanie SGKP / SGKP Search</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; line-height: 1.6; }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        h1 { text-align: center; color: #0c4a6e; }

        .lang-switch {
            position: absolute;
            top: 2rem;
            left: 2rem;
            display: flex;
            gap: 5px;
        }
        .lang-btn {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #9c9b9b;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        .lang-btn.active {
            background-color: #0c4a6e;
            color: white;
            border-color: #0c4a6e;
        }

        .search-form { display: flex; gap: 10px; margin-bottom: 2rem; }
        #search-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        button { padding: 12px 20px; background-color: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0284c7; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .help-button { position: absolute; top: 2rem; right: 2rem; padding: 8px 16px; background-color: #167c2f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .help-button:hover { background-color: #5a6268; }
        .disclaimer-text { font-size: 0.9em; color: #4a5568; background-color: #f0f4f8; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 2rem; }
        .slider-container { margin-bottom: 1rem; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .slider-container label { font-weight: bold; color: #333; }
        #semantic-slider { width: 80%; cursor: pointer; }
        .result-item { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #fafafa; }
        .result-item h3 { margin: 0 0 5px 0; color: #075985; }
        .info, .info-tom, .typy-container { font-size: 0.9em; margin-bottom: 8px; color: #555; }
        .info-tom { color: #000; }
        .smallinfo { font-size: 0.8em; color: #095d03; margin-bottom: 6px; }
        .typy-tag { display: inline-block; margin-right: 6px; color: #555; }
        .result-item p { margin: 0; }
        #results-info { color: #666; margin-bottom: 10px; }
        em { color: black; background-color: yellow; font-style: normal; padding: 2px 4px; border-radius: 3px; }
        #reset-button { background-color: #6c757d; }
        .pagination-container { display: none; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; }
        .pagination-info { font-size: 0.9em; color: #555; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 750px; border-radius: 8px; position: relative; max-height: 90vh; overflow-y: auto; }
        #help-modal .modal-content { max-width: 850px; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-text-content { background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
        .entry-nazwa-link { cursor: pointer; color: #075985; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switch">
            <button type="button" class="lang-btn active" onclick="setLanguage('pl')">PL</button>
            <button type="button" class="lang-btn" onclick="setLanguage('en')">EN</button>
        </div>

        <button id="help-button" class="help-button" title="Informacje na temat aplikacji" data-i18n-title="help_tooltip" data-i18n="help_btn">Pomoc</button>
        <h1 data-i18n="main_title">üìú Wyszukiwarka informacji w SGKP</h1>

        <form id="search-form">
            <div class="slider-container">
                <label for="semantic-slider"><span data-i18n="slider_label">Balans S≈Ç√≥w Kluczowych i Semantyki:</span> <span id="slider-value">0%</span></label>
                <input type="range" id="semantic-slider" name="ratio" min="0" max="100" value="0">
            </div>

            <div class="search-form">
                <input type="text" id="search-input" placeholder="np. 'mielenie ziarna'..." data-i18n-placeholder="search_placeholder">
                <button type="submit" title="Wyszukiwanie wed≈Çug podanych parametr√≥w" data-i18n-title="search_tooltip" data-i18n="search_btn">Szukaj</button>
                <button type="button" id="reset-button" title="Wyczy≈õƒá wyniki" data-i18n-title="reset_tooltip" data-i18n="reset_btn">Wyczy≈õƒá</button>
            </div>
        </form>

        <div class="disclaimer-text" data-i18n="disclaimer">
            * Mechanizm wyszukiwania znajduje siƒô obecnie na wczesnym etapie test√≥w, wyniki mogƒÖ byƒá niekompletne lub niedok≈Çadne. Zapoznaj siƒô z instrukcjami (Pomoc).
        </div>

        <div id="results-info"></div>
        <div id="results"></div>

        <div id="pagination" class="pagination-container">
            <button id="first-page" type="button" title="Id≈∫ do pierwszej strony wynik√≥w" data-i18n-title="pagination_first" data-i18n="pagination_first_text">&laquo; Pierwsza</button>
            <button id="prev-page" type="button" title="Id≈∫ do poprzedniej strony wynik√≥w" data-i18n-title="pagination_prev" data-i18n="pagination_prev_text">Poprzednia</button>

            <span id="pagination-info" class="pagination-info">Strona 1</span>

            <button id="next-page" type="button" title="Id≈∫ do nastƒôpnej strony wynik√≥w" data-i18n-title="pagination_next" data-i18n="pagination_next_text">Nastƒôpna</button>
            <button id="last-page" type="button" title="Id≈∫ do ostatniej strony wynik√≥w" data-i18n-title="pagination_last" data-i18n="pagination_last_text">Ostatnia &raquo;</button>
        </div>
    </div>

    <div id="entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-help-button">&times;</span>
            <div id="help-content-pl" class="help-lang-content">
                <h2>Pomoc</h2>
                <p>Witaj w wyszukiwarce wektorowej SGKP!</p>
                <p>SGKP czyli <a href="https://pl.wikipedia.org/wiki/S%C5%82ownik_geograficzny_Kr%C3%B3lestwa_Polskiego" target="_blank">S≈Çownik Geograficzny Kr√≥lestwa Polskiego</a><br>
            Uwaga: aplikacja zawiera obecnie wstƒôpnie przetworzonƒÖ tre≈õƒá S≈Çownika, mogƒÖ wystƒôpowaƒá liter√≥wki, b≈Çƒôdy w podziale tre≈õci hase≈Ç itp.
            </p>
            <p><strong>Jak szukaƒá:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Wpisz w pole wyszukiwania interesujƒÖcƒÖ Ciƒô frazƒô np. "mielenie ziarna", "Karaim", "piwo browar", "m≈Çyn parowy", "Poniatowski", "Namys≈Ç√≥w" - bez cudzys≈Çow√≥w, wersja z cudzys≈Ç√≥wami dla wielu s≈Ç√≥w oznacza≈Çaby wyszukiwanie dok≈Çadnej frazy. Mo≈ºna na przyk≈Çad por√≥wnaƒá¬†wyniki wyszukiwania dla: Stanis≈Çaw August Poniatowski (3 tys. wynik√≥w) i "Stanis≈Çaw August Poniatowski" (6 wynik√≥w).</li>
                <li>Naci≈õnij "Szukaj" lub klawisz Enter.</li>
                <li>Wyszukiwarka korzysta z wyszukiwania hybrydowego, ≈ÇƒÖczƒÖc s≈Çowa kluczowe z wyszukiwaniem wektorowym (semantycznym), aby daƒá jak najlepsze wyniki. Ustawienie suwaka "Balans S≈Ç√≥w Kluczowych  i Semantyki" decyduje o wp≈Çywie danego typu wyszukiwania na wynik. Domy≈õlne ustawienie na 0% oznacze wyszukiwanie tylko wed≈Çug s≈Ç√≥w kluczowych, ustawienie na 100% to eksperymentalne wyszukiwanie tylko wektorowe (semantyczne).</li>
                <li>Wyszukiwanie wg s≈Ç√≥w kluczowych szuka hase≈Ç, w kt√≥rych wystƒôpujƒÖ wprowadzone w polu wyszukiwania s≈Çowa, wyszukiwanie odbywa siƒô z pewnƒÖ tolerancjƒÖ tzn. wprowadzajƒÖc s≈Çowo "m≈Çyny" otrzymamy wyniki w kt√≥rych znajdowa≈Ço siƒô¬†zar√≥wno to s≈Çowo, jak i "m≈Çyn", "m≈Çynowi" itp.</li>
                <li>Wyszukiwanie wektorowe (semantyczne) wyszukuje has≈Ça wed≈Çug znaczenia wprowadzonych wyraz√≥w, dlatego sformu≈Çowanie "mielenie ziarna" zwr√≥ci has≈Ça zwierajƒÖce s≈Çowa m≈Çyn, m≈Çyny. To samo sformu≈Çowanie wprowadzone przy ustawieniu na wyszukiwanie tylko wed≈Çug s≈Ç√≥w kluczowych zwr√≥ci has≈Ça, w kt√≥rych wystƒôpuje s≈Çowo "mielenie".</li>
                <li>Wyszukiwanie semantyczne nie odpowiada na pytania (jak chat z modelem jƒôzykowym), zwraca jedynie wyniki o zbli≈ºonym znaczeniu do zapytania, nie zwraca te≈º¬†kompletnej, precyzyjnej listy informacji.</li>
            </ul>
            <p><strong>Wyniki:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Je≈ºeli wynik√≥w jest wiƒôcej ni≈º 20, aplikacja wy≈õwietla wyniki z podzia≈Çem na strony, u do≈Çu listy wynik√≥w znajdujƒÖ siƒô przyciski do nawigacji miƒôdzy stronami.</li>
                <li>Kliknij na tytu≈Ç (label) wyniku, aby zobaczyƒá wiƒôcej szczeg√≥≈Ç√≥w w osobnym oknie.</li>
                <li>Dla ka≈ºdego has≈Ça na li≈õcie wynik√≥w wy≈õwietlany jest numer tomu i numer strony na kt√≥rej zaczyna siƒô dane has≈Ço w wersji drukowanej, numer strony jest linkiem, kt√≥ry prowadzi do skanu strony na serwerach ICM (Interdyscyplinarnego Centrum Modelowania Matematycznego i Komputerowego UW).</li>
                <li>U≈ºyj przycisku "Wyczy≈õƒá", aby zresetowaƒá widok.</li>
            </ul>
            </div>

            <div id="help-content-en" class="help-lang-content" style="display: none;">
                <h2>Help</h2>
                <p>Welcome to the SGKP Search!</p>
                <p>SGKP stands for the <a href="https://en.wikipedia.org/wiki/Geographical_Dictionary_of_the_Kingdom_of_Poland" target="_blank">Geographical Dictionary of the Kingdom of Poland</a>.<br>
                Note: The application contains pre-processed dictionary content; typos may occur.</p>
                <p><strong>How to search:</strong></p>
                <ul style="margin-top: -10px;">
                    <li>Enter a phrase in the search box, e.g., "mielenie ziarna", "Karaim", "browar piwo", "Namys≈Ç√≥w", "m≈Çyn parowy", "Poniatowski", without quotation marks; the version with quotation marks for multiple words would mean searching for the exact phrase. For example, you can compare the search results for: Stanis≈Çaw August Poniatowski (3,000 results) and ‚ÄòStanis≈Çaw August Poniatowski‚Äô (6 results).</li>
                    <li>Press ‚ÄòSearch‚Äô or the Enter key.</li>
                   <li>The search engine uses hybrid search, combining keywords with vector (semantic) search to give the best results. The ‚ÄòKeyword and Semantics Balance‚Äô slider setting determines the influence of each type of search on the result. The default setting of 0% means searching only by keywords, while the setting of 100% means experimental vector (semantic) search only.
                <li>Keyword search looks for terms that contain the words entered in the search field, with a certain degree of tolerance, i.e. entering the word ‚Äòm≈Çyny‚Äô will return results containing both that word and ‚Äúm≈Çyn‚Äù, ‚Äòm≈Çynom‚Äô, etc.
                <li>Vector (semantic) search searches for terms according to the meaning of the words entered, so the phrase ‚Äòmielenie ziarna‚Äô will return terms containing the words mill and mills. The same phrase entered with the keyword-only search setting will return terms containing the word ‚Äògrinding‚Äô. </li>
                <li>Semantic search does not answer questions (like a chat with a language model), it only returns results with a meaning similar to the query, and does not return a complete, precise list of information. </li>
            </ul>
            <p><strong>Results:</strong></p>
            <ul style="margin-top: -10px;">
                <li>If there are more than 20 results, the application displays the results divided into pages, with buttons at the bottom of the results list for navigating between pages.
                <li>Click on the title (label) of the result to see more details in a separate window. </li>
                <li>For each entry in the results list, the volume number and page number where the entry begins in the printed version are displayed. The page number is a link that leads to a scan of the page on the ICM (Interdisciplinary Centre for Mathematical and Computational Modelling, University of Warsaw) servers. </li>
                <li>Use the ‚ÄòClear‚Äô button to reset the view. </li>
                </ul>
            </div>
        </div>
    </div>

    <script>

        const dictionary = {
            pl: {
                main_title: "üìú Wyszukiwarka informacji w SGKP",
                help_btn: "Pomoc",
                help_tooltip: "Informacje na temat aplikacji",
                slider_label: "Balans S≈Ç√≥w Kluczowych i Semantyki:",
                search_placeholder: "np. 'mielenie ziarna'...",
                search_btn: "Szukaj",
                search_tooltip: "Wyszukiwanie wed≈Çug podanych parametr√≥w",
                reset_btn: "Wyczy≈õƒá",
                reset_tooltip: "Wyczy≈õƒá wyniki",
                disclaimer: "* Mechanizm wyszukiwania znajduje siƒô obecnie na wczesnym etapie test√≥w, wyniki mogƒÖ byƒá niekompletne lub niedok≈Çadne. Zapoznaj siƒô z instrukcjami (Pomoc).",
                pagination_first: "Id≈∫ do pierwszej strony wynik√≥w",
                pagination_first_text: "&laquo; Pierwsza",
                pagination_prev: "Id≈∫ do poprzedniej strony wynik√≥w",
                pagination_prev_text: "Poprzednia",
                pagination_next: "Id≈∫ do nastƒôpnej strony wynik√≥w",
                pagination_next_text: "Nastƒôpna",
                pagination_last: "Id≈∫ do ostatniej strony wynik√≥w",
                pagination_last_text: "Ostatnia &raquo;",
                // dynamiczne etykiety
                lbl_vol: "Tom",
                lbl_page: "strona",
                lbl_district: "powiat",
                lbl_parish: "parafia katolicka",
                lbl_type: "typ punktu osadniczego",
                lbl_sacral: "obiekty sakralne",
                lbl_industrial: "obiekty przemys≈Çowe",
                lbl_results: "Pokazujƒô wyniki",
                lbl_of: "z ok.",
                lbl_no_results: "Brak wynik√≥w.",
                lbl_searching: "Wyszukiwanie...",
                lbl_error: "B≈ÇƒÖd podczas pobierania wynik√≥w.",
                lbl_page_count: "Strona"
            },
            en: {
                main_title: "üìú SGKP Search",
                help_btn: "Help",
                help_tooltip: "Information about the application",
                slider_label: "Keyword vs Semantic Balance:",
                search_placeholder: "e.g., 'mielenie ziarna'...",
                search_btn: "Search",
                search_tooltip: "Search using provided parameters",
                reset_btn: "Clear",
                reset_tooltip: "Clear results",
                disclaimer: "* The search mechanism is in early testing; results may be incomplete or inaccurate. Please read the instructions (Help).",
                pagination_first: "Go to first page",
                pagination_first_text: "&laquo; First",
                pagination_prev: "Go to previous page",
                pagination_prev_text: "Prev",
                pagination_next: "Go to next page",
                pagination_next_text: "Next",
                pagination_last: "Go to last page",
                pagination_last_text: "Last &raquo;",
                // dynamiczne etykiety
                lbl_vol: "Vol",
                lbl_page: "page",
                lbl_district: "district",
                lbl_parish: "catholic parish",
                lbl_type: "settlement type",
                lbl_sacral: "sacral objects",
                lbl_industrial: "industrial objects",
                lbl_results: "Showing results",
                lbl_of: "of approx.",
                lbl_no_results: "No results found.",
                lbl_searching: "Searching...",
                lbl_error: "Error retrieving results.",
                lbl_page_count: "Page"
            }
        };

        let currentLang = localStorage.getItem('sgkp_lang') || 'pl';

        function t(key) {
            return dictionary[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('sgkp_lang', lang);

            // Update buttons state
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.toLowerCase() === lang);
            });

            // t≈Çumaczenie element√≥w statycznych
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = t(key);
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                el.title = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });

            // Pomoc, zale≈ºnie od wersji jƒôzykowej
            document.getElementById('help-content-pl').style.display = lang === 'pl' ? 'block' : 'none';
            document.getElementById('help-content-en').style.display = lang === 'en' ? 'block' : 'none';

            // od≈õwie≈ºanie
            if (document.getElementById('results').children.length > 0) {
                 if(typeof lastResultData !== 'undefined') {
                     displayResults(lastResultData);
                     updatePagination(lastResultData);
                 }
            }
        }

        const form = document.getElementById('search-form');
        const input = document.getElementById('search-input');
        const slider = document.getElementById('semantic-slider');
        const sliderValueSpan = document.getElementById('slider-value');
        const resultsContainer = document.getElementById('results');
        const resultsInfo = document.getElementById('results-info');
        const resetButton = document.getElementById('reset-button');
        // Paginacja
        const paginationContainer = document.getElementById('pagination');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');
        const paginationInfo = document.getElementById('pagination-info');

        const modal = document.getElementById('entry-modal');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.close-button');
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');

        let currentPage = 1;
        let totalPages = 0;
        const resultsPerPage = 20;
        let currentQuery = '';
        let lastResultData = null; // do ponownego renderowania przy zmianie jƒôzyka

        setLanguage(currentLang);

        function resetApplication() {
            input.value = '';
            resultsContainer.innerHTML = '';
            resultsInfo.textContent = '';
            paginationContainer.style.display = 'none';
            currentPage = 1;
            lastResultData = null;
            input.focus();
        }

        const volumeToRoman = {
            '01': 'I', '02': 'II', '03': 'III', '04': 'IV', '05': 'V',
            '1': 'I', '2': 'II', '3': 'III', '4': 'IV', '5': 'V',
            '06': 'VI', '07': 'VII', '08': 'VIII', '09': 'IX', '10': 'X',
            '6': 'VI', '7': 'VII', '8': 'VIII', '9': 'IX',
            '11': 'XI', '12': 'XII', '13': 'XIII', '14': 'XIV', '15': 'XV_cz.1',
            '16': 'XV_cz.2'
        };

        function generateScanLink(tom, strona) {
            const romanVolume = volumeToRoman[tom];
            if (!romanVolume || !strona) return null;
            return `http://dir.icm.edu.pl/Slownik_geograficzny/Tom_${romanVolume}/${strona}`;
        }

        async function performSearch(page = 1) {
            const query = input.value;
            const ratio = slider.value;
            if (!query) { return; }

            if (query !== currentQuery) {
               currentQuery = query;
            }

            resultsInfo.textContent = t('lbl_searching');

            try {
                const params = new URLSearchParams({ q: query, ratio: ratio, page: page });
                const response = await fetch(`search?${params}`);
                const data = await response.json();

                currentPage = page;
                lastResultData = data;
                displayResults(data);
                updatePagination(data);

            } catch (error) {
                resultsInfo.textContent = t('lbl_error');
                console.error('Wyszukiwanie nie powiod≈Ço siƒô:', error);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            currentPage = 1;
            performSearch(currentPage);
        });

        slider.addEventListener('input', () => {
            sliderValueSpan.textContent = `${slider.value}%`;
        });

        firstPageBtn.addEventListener('click', () => { if (currentPage > 1) performSearch(1); });
        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) performSearch(currentPage - 1); });
        nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) performSearch(currentPage + 1); });
        lastPageBtn.addEventListener('click', () => { if (currentPage < totalPages) performSearch(totalPages); });

        function updatePagination(data) {
            const totalHits = data.estimatedTotalHits;
            totalPages = Math.ceil(totalHits / resultsPerPage);

            if (totalHits > 0) {
                paginationContainer.style.display = 'flex';
                paginationInfo.textContent = `${t('lbl_page_count')} ${currentPage} / ${totalPages}`;

                const isFirst = currentPage === 1;
                firstPageBtn.disabled = isFirst;
                prevPageBtn.disabled = isFirst;

                const isLast = currentPage === totalPages || totalPages === 0;
                nextPageBtn.disabled = isLast;
                lastPageBtn.disabled = isLast;
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function displayResults(data) {
            resultsContainer.innerHTML = '';

            const total = data.estimatedTotalHits;
            const time = data.processingTimeMs;

            const start = (currentPage - 1) * resultsPerPage + 1;
            let end = currentPage * resultsPerPage;
            if (end > total) end = total;

            if (data.hits && data.hits.length > 0) {
                 resultsInfo.textContent = `${t('lbl_results')} ${start}-${end} ${t('lbl_of')} ${total} (${time}ms).`;

                data.hits.forEach(hit => {
                    const item = document.createElement('div');
                    item.className = 'result-item';

                    let typyHtml = '';
                    if (hit.typ_punktu_osadniczego && hit.typ_punktu_osadniczego.length > 0) {
                        const typyTags = hit.typ_punktu_osadniczego.map(typ => `<span class="typy-tag">${typ}</span>`).join(',');
                        typyHtml = `<div class="typy-container">${t('lbl_type')}: ${typyTags}</div>`;
                    }

                    const scanLink = generateScanLink(hit.tom, hit.strona);
                    const stronaHtml = scanLink
                        ? `<a href="${scanLink}" target="_blank" title="Zobacz skan strony" style="color:#0ea5e9;">${hit.strona}</a>`
                        : hit.strona;

                    item.innerHTML = `
                        <h3 class="entry-nazwa-link" data-id="${hit.ID}">${hit.nazwa}</h3>
                        <p class="info-tom">${t('lbl_vol')}: ${hit.tom}, ${t('lbl_page')}: ${stronaHtml}</p>
                        ${hit.powiat_ujednolicony ? `<p class="info">${t('lbl_district')}: ${hit.powiat_ujednolicony}</p>` : ''}
                        ${hit.parafia_katolicka ? `<p class="info">${t('lbl_parish')}: ${hit.parafia_katolicka}</p>` : ''}
                        ${typyHtml}
                        <p class="smallinfo">RankingScore: ${(hit._rankingScore ? hit._rankingScore.toFixed(2) : 'N/A')}</p>
                        <p>${hit._formatted ? hit._formatted.text : hit.text}</p>
                    `;
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = `<p>${t('lbl_no_results')}</p>`;
                resultsInfo.textContent = '';
                paginationContainer.style.display = 'none';
            }
        }

        async function openModal(entryId) {
            try {
                const response = await fetch(`entry/${entryId}`);
                if (!response.ok) { throw new Error(t('lbl_error')); }
                const entry = await response.json();

                let typyHtml = '';
                if (entry.typ_punktu_osadniczego && entry.typ_punktu_osadniczego.length > 0) {
                    const typyTags = entry.typ_punktu_osadniczego.map(typ => `<span class="typy-tag">${typ}</span>`).join(', ');
                    typyHtml = `<div class="typy-container">${t('lbl_type')}: ${typyTags}</div>`;
                }

                let obiektySakralneHTML = '';
                if (entry.obiekty_sakralne && entry.obiekty_sakralne.length > 0) {
                    const sakralneTags = entry.obiekty_sakralne.map(obiekt => `<span class="typy-tag">${obiekt}</span>`).join(', ');
                    obiektySakralneHTML = `<div class="typy-container">${t('lbl_sacral')}: ${sakralneTags}</div>`;
                }

                let przemysloweHTML = '';
                if (entry.przemyslowe && entry.przemyslowe.length > 0) {
                    const przemysloweTags = entry.przemyslowe.map(obiekt => `<span class="typy-tag">${obiekt}</span>`).join(', ');
                    przemysloweHTML = `<div class="typy-container">${t('lbl_industrial')}: ${przemysloweTags}</div>`;
                }

                const scanLink = generateScanLink(entry.tom, entry.strona);
                const stronaHtml = scanLink
                    ? `<a href="${scanLink}" target="_blank" title="Zobacz skan strony" style="color:#0ea5e9;">${entry.strona}</a>`
                    : entry.strona;

                modalBody.innerHTML = `
                    <h2>${entry.nazwa}</h2>
                    ${entry.ID ? `<p class="info">ID: ${entry.ID}</p>` : ''}
                    <p class="info-tom">${t('lbl_vol')}: ${entry.tom}, ${t('lbl_page')}: ${stronaHtml}</p>
                    ${entry.powiat_ujednolicony ? `<p class="info">${t('lbl_district')}: ${entry.powiat_ujednolicony}</p>` : ''}
                    ${entry.parafia_katolicka ? `<p class="info">${t('lbl_parish')}: ${entry.parafia_katolicka}</p>` : ''}
                    ${typyHtml}
                    ${obiektySakralneHTML}
                    ${przemysloweHTML}
                    <p class="modal-text-content">${entry.text}</p>
                `;
                modal.style.display = 'block';
            } catch (error) {
                modalBody.innerHTML = `<p style="color: red;">${error.message}</p>`;
                modal.style.display = 'block';
            }
        }

        function closeModal() { modal.style.display = 'none'; modalBody.innerHTML = ''; }
        helpButton.addEventListener('click', () => { helpModal.style.display = 'block'; });
        closeHelpButton.addEventListener('click', () => { helpModal.style.display = 'none'; });
        resultsContainer.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('entry-nazwa-link')) {
                e.preventDefault();
                const entryId = e.target.dataset.id;
                openModal(entryId);
            }
        });
        resetButton.addEventListener('click', resetApplication);
        closeButton.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
            if (e.target === helpModal) helpModal.style.display = 'none';
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (modal.style.display === 'block') closeModal();
                if (helpModal.style.display === 'block') helpModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
