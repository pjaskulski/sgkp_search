<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyszukiwanie SGKP</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; line-height: 1.6; }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        h1 { text-align: center; color: #0c4a6e; }
        h5 { text-align: center; color: #0c4a6e; }
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
        }
        #search-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            padding: 12px 20px;
            background-color: #0ea5e9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background-color: #0284c7; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .help-button {
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 8px 16px;
            background-color: #167c2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .help-button:hover { background-color: #5a6268; }

        .disclaimer-text {
            font-size: 0.9em;
            color: #4a5568;
            background-color: #f0f4f8;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .slider-container {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .slider-container label { font-weight: bold; color: #333; }
        #semantic-slider { width: 80%; cursor: pointer; }

        /* Wyniki */
        .result-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .result-item h3 {
            margin: 0 0 5px 0;
            color: #075985;
        }
        .info {
            font-size: 0.9em;
            font-style: normal;
            color: #555;
            margin-top: -5px;
            margin-bottom: 8px;
        }
        .info-tom {
            font-size: 0.9em;
            color: #000000;
            margin-top: -5px;
            margin-bottom: 8px;
        }
        .smallinfo {
            font-size: 0.8em;
            color: #095d03;
            margin-top: -5px;
            margin-bottom: 6px;
        }
        .typy-container {
            font-size: 0.9em;
            font-style: normal;
            color: #555;
            margin-top: -2px;
        }
        .typy-tag {
            display: inline-block;
            font-size: 0.9em;
            font-style: normal;
            color: #555;
            margin-right: 6px;
        }
        .result-item p { margin: 0; }
        #results-info {
            color: #666;
            font-style: normal;
            margin-bottom: 10px;
        }

        em {
            color: black;
            background-color: yellow;
            font-style: normal;
            padding: 2px 4px;
            border-radius: 3px;
        }

        #reset-button { background-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }

        /* Paginacja */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            display: none; /* Domylnie ukryte */
        }
        .pagination-info { font-size: 0.9em; color: #555; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 750px;
            border-radius: 8px;
            position: relative;
            max-height: 90vh; /* maksymalna wysoko to 90% widoku ekranu */
            overflow-y: auto; /* przewijanie wewntrz okna */
        }
        #help-modal .modal-content { max-width: 850px; }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: black; }
        .modal-text-content {
            /*max-height: 60vh;
            overflow-y: auto;*/
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .entry-nazwa-link {
            cursor: pointer;
            color: #075985;
            text-decoration: underline;
        }
        .entry-nazwa-link:hover { color: #0ea5e9; }
    </style>
</head>
<body>

    <div class="container">
        <button id="help-button" class="help-button" title="Informacje na temat aplikacji">Pomoc</button>
        <h1> Wyszukiwarka informacji w SGKP</h1>

        <form id="search-form">
            <div class="slider-container">
                <label for="semantic-slider">Balans S贸w Kluczowych i Semantyki: <span id="slider-value">0%</span></label>
                <input type="range" id="semantic-slider" name="ratio" min="0" max="100" value="0">
            </div>

            <div class="search-form">
                <input type="text" id="search-input" placeholder="np. 'mielenie ziarna'...">
                <button type="submit" title="Wyszukiwanie wedug podanych parametr贸w">Szukaj</button>
                <button type="button" id="reset-button" title="Wyczywyniki">Wyczy</button>
            </div>
        </form>

        <div class="disclaimer-text">
            * Mechanizm wyszukiwania znajduje si obecnie na wczesnym etapie test贸w, wyniki mog by niekompletne lub niedokadne. Zapoznaj si z instrukcjami (Pomoc).
        </div>

        <div id="results-info"></div>
        <div id="results"></div>

        <div id="pagination" class="pagination-container">
            <button id="first-page" type="button" title="Id藕 do pierwszej strony wynik贸w">&laquo; Pierwsza</button>
            <button id="prev-page" type="button" title="Id藕 do poprzedniej strony wynik贸w">Poprzednia</button>

            <span id="pagination-info" class="pagination-info">Strona 1</span>

            <button id="next-page" type="button" title="Id藕 do nastpnej strony wynik贸w">Nastpna</button>
            <button id="last-page" type="button" title="Id藕 do ostatniej strony wynik贸w">Ostatnia &raquo;</button>
        </div>
    </div>

    <div id="entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-help-button">&times;</span>
            <h2>Pomoc</h2>
            <p>Witaj w wyszukiwarce wektorowej SGKP!</p>
            <p>SGKP czyli <a href="https://pl.wikipedia.org/wiki/S%C5%82ownik_geograficzny_Kr%C3%B3lestwa_Polskiego" target="_blank">Sownik Geograficzny Kr贸lestwa Polskiego</a><br>
            Uwaga: aplikacja zawiera obecnie wstpnie przetworzon tre Sownika, mog wystpowa liter贸wki, bdy w podziale treci hase itp.
            </p>
            <p><strong>Jak szuka:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Wpisz w pole wyszukiwania interesujc Ci fraz np. "mielenie ziarna", "Karaim", "piwo browar", "myn parowy", "Poniatowski", "Namys贸w" - bez cudzysow贸w, wersja z cudzys贸wami dla wielu s贸w oznaczaaby wyszukiwanie dokadnej frazy. Mo偶na na przykad por贸wnawyniki wyszukiwania dla: Stanisaw August Poniatowski (3 tys. wynik贸w) i "Stanisaw August Poniatowski" (6 wynik贸w).</li>
                <li>Nacinij "Szukaj" lub klawisz Enter.</li>
                <li>Wyszukiwarka korzysta z wyszukiwania hybrydowego, czc sowa kluczowe z wyszukiwaniem wektorowym (semantycznym), aby da jak najlepsze wyniki. Ustawienie suwaka "Balans S贸w Kluczowych  i Semantyki" decyduje o wpywie danego typu wyszukiwania na wynik. Domylne ustawienie na 0% oznacze wyszukiwanie tylko wedug s贸w kluczowych, ustawienie na 100% to eksperymentalne wyszukiwanie tylko wektorowe (semantyczne).</li>
                <li>Wyszukiwanie wg s贸w kluczowych szuka hase, w kt贸rych wystpuj wprowadzone w polu wyszukiwania sowa, wyszukiwanie odbywa si z pewn tolerancj tzn. wprowadzajc sowo "myny" otrzymamy wyniki w kt贸rych znajdowao sizar贸wno to sowo, jak i "myn", "mynowi" itp.</li>
                <li>Wyszukiwanie wektorowe (semantyczne) wyszukuje hasa wedug znaczenia wprowadzonych wyraz贸w, dlatego sformuowanie "mielenie ziarna" zwr贸ci hasa zwierajce sowa myn, myny. To samo sformuowanie wprowadzone przy ustawieniu na wyszukiwanie tylko wedug s贸w kluczowych zwr贸ci hasa, w kt贸rych wystpuje sowo "mielenie".</li>
                <li>Wyszukiwanie semantyczne nie odpowiada na pytania (jak chat z modelem jzykowym), zwraca jedynie wyniki o zbli偶onym znaczeniu do zapytania, nie zwraca te偶kompletnej, precyzyjnej listy informacji.</li>
            </ul>
            <p><strong>Wyniki:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Je偶eli wynik贸w jest wicej ni偶 20, aplikacja wywietla wyniki z podziaem na strony, u dou listy wynik贸w znajduj si przyciski do nawigacji midzy stronami.</li>
                <li>Kliknij na tytu (label) wyniku, aby zobaczy wicej szczeg贸贸w w osobnym oknie.</li>
                <li>Dla ka偶dego hasa na licie wynik贸w wywietlany jest numer tomu i numer strony na kt贸rej zaczyna si dane haso w wersji drukowanej, numer strony jest linkiem, kt贸ry prowadzi do skanu strony na serwerach ICM (Interdyscyplinarnego Centrum Modelowania Matematycznego i Komputerowego UW).</li>
                <li>U偶yj przycisku "Wyczy", aby zresetowa widok.</li>
            </ul>
        </div>
    </div>

    <script>
        const form = document.getElementById('search-form');
        const input = document.getElementById('search-input');
        const slider = document.getElementById('semantic-slider');
        const sliderValueSpan = document.getElementById('slider-value');
        const resultsContainer = document.getElementById('results');
        const resultsInfo = document.getElementById('results-info');
        const resetButton = document.getElementById('reset-button');

        // Paginacja
        const paginationContainer = document.getElementById('pagination');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');
        const paginationInfo = document.getElementById('pagination-info');

        const modal = document.getElementById('entry-modal');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.close-button');
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');

        // Zmienne stanu
        let currentPage = 1;
        let totalPages = 0;
        const resultsPerPage = 20;
        let currentQuery = '';

        function resetApplication() {
            input.value = '';
            resultsContainer.innerHTML = '';
            resultsInfo.textContent = '';
            paginationContainer.style.display = 'none';
            currentPage = 1;
            input.focus();
        }

        // Mapa konwersji numer贸w tom贸w z formatu "01" na rzymskie "I"
        const volumeToRoman = {
            '01': 'I', '02': 'II', '03': 'III', '04': 'IV', '05': 'V',
            '1': 'I', '2': 'II', '3': 'III', '4': 'IV', '5': 'V',
            '06': 'VI', '07': 'VII', '08': 'VIII', '09': 'IX', '10': 'X',
            '6': 'VI', '7': 'VII', '8': 'VIII', '9': 'IX',
            '11': 'XI', '12': 'XII', '13': 'XIII', '14': 'XIV', '15': 'XV_cz.1',
            '16': 'XV_cz.2'
        };

        function generateScanLink(tom, strona) {
            // Sprawdzamy czy mamy odpowiednik rzymski, jeli nie (bd danych), zwracamy null
            const romanVolume = volumeToRoman[tom];
            if (!romanVolume || !strona) return null;

            return `http://dir.icm.edu.pl/Slownik_geograficzny/Tom_${romanVolume}/${strona}`;
        }

        async function performSearch(page = 1) {
            const query = input.value;
            const ratio = slider.value;
            if (!query) { return; }

            // Jeli zapytanie si zmienio, resetujemy na 1 stron (chyba 偶e to wywoanie z paginacji)
            if (query !== currentQuery) {
               // currentPage = 1; // Ta logika jest ju偶 obsu偶ona w submit form
               currentQuery = query;
            }

            resultsInfo.textContent = 'Wyszukiwanie...';

            try {
                // Dodajemy parametr page
                const params = new URLSearchParams({ q: query, ratio: ratio, page: page });
                const response = await fetch(`search?${params}`);
                const data = await response.json();

                currentPage = page; // Aktualizuj aktualn stron po udanym pobraniu
                displayResults(data);
                updatePagination(data); // Aktualizuj przyciski

            } catch (error) {
                resultsInfo.textContent = 'Bd podczas pobierania wynik贸w.';
                console.error('Wyszukiwanie nie powiodo si:', error);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            currentPage = 1; // Nowe wyszukiwanie zawsze od strony 1
            performSearch(currentPage);
        });

        slider.addEventListener('input', () => {
            sliderValueSpan.textContent = `${slider.value}%`;
        });

        // Obsuga przycisk贸w paginacji
        // Pierwsza strona
        firstPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                performSearch(1);
            }
        });

        // Poprzednia strona
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                performSearch(currentPage - 1);
            }
        });

        // Nastpna strona
        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                performSearch(currentPage + 1);
            }
        });

        // Ostatnia strona
        lastPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                performSearch(totalPages);
            }
        });

        // Funkcja aktualizujca stan przycisk贸w
        function updatePagination(data) {
            const totalHits = data.estimatedTotalHits;
            totalPages = Math.ceil(totalHits / resultsPerPage);

            if (totalHits > 0) {
                paginationContainer.style.display = 'flex';
                paginationInfo.textContent = `Strona ${currentPage} z ${totalPages}`;

                // Jeli jestemy na pierwszej stronie, blokujemy "Pierwsza" i "Poprzednia"
                const isFirst = currentPage === 1;
                firstPageBtn.disabled = isFirst;
                prevPageBtn.disabled = isFirst;

                // Jeli jestemy na ostatniej stronie, blokujemy "Nastpna" i "Ostatnia"
                const isLast = currentPage === totalPages || totalPages === 0;
                nextPageBtn.disabled = isLast;
                lastPageBtn.disabled = isLast;

            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function displayResults(data) {
            resultsContainer.innerHTML = '';

            const total = data.estimatedTotalHits;
            const time = data.processingTimeMs;

            // Obliczanie zakresu wywietlania (np. 1-20)
            const start = (currentPage - 1) * resultsPerPage + 1;
            let end = currentPage * resultsPerPage;
            if (end > total) end = total;

            if (data.hits && data.hits.length > 0) {
                 resultsInfo.textContent = `Pokazuj wyniki ${start}-${end} z ok. ${total} (${time}ms).`;

                data.hits.forEach(hit => {
                    const item = document.createElement('div');
                    item.className = 'result-item';

                    let typyHtml = '';
                    if (hit.typ_punktu_osadniczego && hit.typ_punktu_osadniczego.length > 0) {
                        const typyTags = hit.typ_punktu_osadniczego.map(typ => `<span class="typy-tag">${typ}</span>`).join(',');
                        typyHtml = `<div class="typy-container">typ punktu osadniczego: ${typyTags}</div>`;
                    }

                    // Generowanie linku do skanu
                    const scanLink = generateScanLink(hit.tom, hit.strona);
                    const stronaHtml = scanLink
                        ? `<a href="${scanLink}" target="_blank" title="Zobacz skan strony" style="color:#0ea5e9;">${hit.strona}</a>`
                        : hit.strona;

                    item.innerHTML = `
                        <h3 class="entry-nazwa-link" data-id="${hit.ID}">${hit.nazwa}</h3>
                        <p class="info-tom">Tom: ${hit.tom}, strona: ${stronaHtml}</p>
                        ${hit.powiat_ujednolicony ? `<p class="info">powiat: ${hit.powiat_ujednolicony}</p>` : ''}
                        ${hit.parafia_katolicka ? `<p class="info">parafia katolicka: ${hit.parafia_katolicka}</p>` : ''}
                        ${typyHtml}
                        <p class="smallinfo">RankingScore: ${(hit._rankingScore ? hit._rankingScore.toFixed(2) : 'N/A')}</p>
                        <p>${hit._formatted ? hit._formatted.text : hit.text}</p>
                    `;
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<p>Brak wynik贸w.</p>';
                resultsInfo.textContent = '';
                paginationContainer.style.display = 'none';
            }
        }

        // Reszta funkcji (openModal, closeModal, etc.) pozostaje bez zmian jak w oryginale
        async function openModal(entryId) {
            try {
                const response = await fetch(`entry/${entryId}`);
                if (!response.ok) { throw new Error('Nie mo偶na zaadowa danych.'); }
                const entry = await response.json();

                let typyHtml = '';
                if (entry.typ_punktu_osadniczego && entry.typ_punktu_osadniczego.length > 0) {
                    const typyTags = entry.typ_punktu_osadniczego.map(typ => `<span class="typy-tag">${typ}</span>`).join(', ');
                    typyHtml = `<div class="typy-container">typ punktu osadniczego: ${typyTags}</div>`;
                }

                let obiektySakralneHTML = '';
                if (entry.obiekty_sakralne && entry.obiekty_sakralne.length > 0) {
                    const sakralneTags = entry.obiekty_sakralne.map(obiekt => `<span class="typy-tag">${obiekt}</span>`).join(', ');
                    obiektySakralneHTML = `<div class="typy-container">obiekty sakralne: ${sakralneTags}</div>`;
                }

                let przemysloweHTML = '';
                if (entry.przemyslowe && entry.przemyslowe.length > 0) {
                    const przemysloweTags = entry.przemyslowe.map(obiekt => `<span class="typy-tag">${obiekt}</span>`).join(', ');
                    przemysloweHTML = `<div class="typy-container">obiekty przemysowe: ${przemysloweTags}</div>`;
                }

                // Generowanie linku do skanu - dla okienka modalnego
                const scanLink = generateScanLink(entry.tom, entry.strona);
                const stronaHtml = scanLink
                    ? `<a href="${scanLink}" target="_blank" title="Zobacz skan strony" style="color:#0ea5e9;">${entry.strona}</a>`
                    : entry.strona;

                modalBody.innerHTML = `
                    <h2>${entry.nazwa}</h2>
                    ${entry.ID ? `<p class="info">ID: ${entry.ID}</p>` : ''}
                    <p class="info-tom">Tom: ${entry.tom}, strona: ${stronaHtml}</p>
                    ${entry.powiat_ujednolicony ? `<p class="info">powiat: ${entry.powiat_ujednolicony}</p>` : ''}
                    ${entry.parafia_katolicka ? `<p class="info">parafia katolicka: ${entry.parafia_katolicka}</p>` : ''}
                    ${typyHtml}
                    ${obiektySakralneHTML}
                    ${przemysloweHTML}
                    <p class="modal-text-content">${entry.text}</p>
                `;
                modal.style.display = 'block';
            } catch (error) {
                modalBody.innerHTML = `<p style="color: red;">${error.message}</p>`;
                modal.style.display = 'block';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
        }

        helpButton.addEventListener('click', () => { helpModal.style.display = 'block'; });
        closeHelpButton.addEventListener('click', () => { helpModal.style.display = 'none'; });

        resultsContainer.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('entry-nazwa-link')) {
                e.preventDefault();
                const entryId = e.target.dataset.id;
                openModal(entryId);
            }
        });

        resetButton.addEventListener('click', resetApplication);
        closeButton.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
            if (e.target === helpModal) helpModal.style.display = 'none';
        });

        // Obsuga klawisza ESC do zamykania okienek modalnych
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Jeli otwarte jest okienko ze szczeg贸ami hasa
                if (modal.style.display === 'block') {
                    closeModal();
                }
                // Jeli otwarte jest okienko pomocy
                if (helpModal.style.display === 'block') {
                    helpModal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
